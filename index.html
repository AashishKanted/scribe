<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .receipt-card { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { border-bottom-color: #111827; color: #111827; }
        .tab-inactive { border-bottom-color: transparent; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Login View -->
        <div id="login-view" class="min-h-screen flex items-center justify-center hidden">
            <div class="text-center p-8 bg-white rounded-2xl shadow-lg border border-gray-100">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Scribe</h1>
                <p class="text-gray-600 mb-6">Your personal AI biographer.</p>
                <button id="google-signin-btn" class="bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-900 transition-all duration-300 flex items-center justify-center mx-auto shadow-md">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.574l6.19 5.238C42.021 35.826 44 30.137 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Main App View -->
        <div id="app-view" class="hidden">
            <!-- Header -->
            <header class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Scribe</h1>
                <div class="flex items-center space-x-4">
                    <div id="user-profile" class="flex items-center space-x-3">
                        <img id="user-photo" src="" alt="User photo" class="w-9 h-9 rounded-full">
                        <span id="user-name" class="font-semibold text-gray-700 hidden sm:block"></span>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-gray-800 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H9m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </header>

            <!-- Tab Navigation -->
            <nav class="mb-8">
                <div class="border-b border-gray-200">
                    <div class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-scribe" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition tab-active">Scribe</button>
                        <button id="tab-friends" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition tab-inactive">Friends</button>
                        <button id="tab-story" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition tab-inactive">My Story</button>
                    </div>
                </div>
            </nav>

            <!-- Main Content: Views will be rendered here -->
            <main id="main-content">
                <!-- Content will be dynamically inserted by JavaScript -->
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { firebaseConfig } from './firebase-config.js';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // --- Global State ---
        let currentUser = null;
        let currentView = 'scribe'; // 'scribe', 'friends', 'story'
        let unsubscribeReceipts = null;
        let unsubscribeFriends = null;

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const mainContent = document.getElementById('main-content');

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await setupUserProfile(user);
                renderApp();
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
            } else {
                currentUser = null;
                if (unsubscribeReceipts) unsubscribeReceipts();
                if (unsubscribeFriends) unsubscribeFriends();
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Sign in error", error));
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function setupUserProfile(user) {
            document.getElementById('user-photo').src = user.photoURL;
            document.getElementById('user-name').textContent = user.displayName;
            
            const profileRef = doc(db, 'profiles', user.uid);
            const profileSnap = await getDoc(profileRef);
            if (!profileSnap.exists()) {
                await setDoc(profileRef, {
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    friends: []
                });
            }
        }

        // --- Tab Navigation ---
        document.getElementById('tab-scribe').addEventListener('click', () => switchTab('scribe'));
        document.getElementById('tab-friends').addEventListener('click', () => switchTab('friends'));
        document.getElementById('tab-story').addEventListener('click', () => switchTab('story'));

        function switchTab(tabName) {
            currentView = tabName;
            updateTabStyles();
            renderApp();
        }

        function updateTabStyles() {
            ['scribe', 'friends', 'story'].forEach(tabId => {
                const tab = document.getElementById(`tab-${tabId}`);
                if (tabId === currentView) {
                    tab.classList.replace('tab-inactive', 'tab-active');
                } else {
                    tab.classList.replace('tab-active', 'tab-inactive');
                }
            });
        }

        // --- Main Render Function ---
        function renderApp() {
            mainContent.innerHTML = ''; // Clear content
            if (!currentUser) return;

            switch (currentView) {
                case 'scribe':
                    renderScribeView();
                    break;
                case 'friends':
                    renderFriendsView();
                    break;
                case 'story':
                    renderStoryView();
                    break;
            }
        }
        
        // --- View Renderers ---
        function renderScribeView() {
            mainContent.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-8">
                        <textarea id="receipt-input" class="w-full p-4 text-lg border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent resize-none" rows="4" placeholder="What's on your mind?"></textarea>
                        <div class="flex justify-end items-center mt-4">
                             <button id="ai-scribe-btn" class="p-2 text-gray-500 hover:text-gray-900 rounded-full transition" title="Pen My Receipt">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button id="save-receipt-btn" class="bg-gray-800 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-900 transition ml-2">Save Receipt</button>
                        </div>
                    </div>
                    <div id="receipts-feed" class="space-y-6"></div>
                </div>
            `;
            attachScribeListeners();
            listenForMyReceipts();
        }
        
        function renderFriendsView() {
            mainContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h2 class="text-xl font-bold mb-4">Add Friend</h2>
                            <div id="add-friend-status"></div>
                            <input type="email" id="friend-email-input" placeholder="Friend's email" class="w-full p-3 border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent mb-3">
                            <button id="add-friend-btn" class="w-full bg-gray-800 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-900 transition">Add</button>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mt-6">
                            <h2 class="text-xl font-bold mb-4">My Friends</h2>
                            <div id="friends-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div id="friend-story-container" class="md:col-span-2">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 min-h-[300px]">
                            <h2 id="friend-story-title" class="text-2xl font-bold mb-6 text-gray-800">Select a friend to view their story</h2>
                            <div id="friend-receipts-feed" class="space-y-6"></div>
                         </div>
                    </div>
                </div>
            `;
            attachFriendsListeners();
            listenForFriends();
        }

        function renderStoryView() {
            mainContent.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 text-center">
                    <h2 class="text-3xl font-bold mb-4">My Story</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto mb-8">This is where your AI Biographer will turn your receipts into scenes, chapters, and volumes of your life story. This feature is coming soon!</p>
                     <div class="flex justify-center items-center space-x-4">
                        <button class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition cursor-not-allowed" disabled>Write this Week's Scene</button>
                        <button class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition cursor-not-allowed" disabled>Write this Month's Chapter</button>
                    </div>
                </div>
            `;
        }
        
        // --- Logic & Listeners ---

        // SCRIBE LOGIC
        function attachScribeListeners() {
            const saveBtn = document.getElementById('save-receipt-btn');
            const aiBtn = document.getElementById('ai-scribe-btn');
            const input = document.getElementById('receipt-input');

            saveBtn.addEventListener('click', async () => {
                const message = input.value.trim();
                if (!message) return;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                await addDoc(collection(db, `users/${currentUser.uid}/receipts`), {
                    message,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorPhoto: currentUser.photoURL,
                    timestamp: serverTimestamp()
                });
                input.value = '';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Receipt';
            });
            
            aiBtn.addEventListener('click', async () => {
                const rawText = input.value.trim();
                if (!rawText) return;
                aiBtn.disabled = true;
                const originalIcon = aiBtn.innerHTML;
                aiBtn.innerHTML = `<svg class="w-6 h-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                try {
                    const getEnhancedReceipt = httpsCallable(functions, 'getEnhancedReceipt');
                    const result = await getEnhancedReceipt({ text: rawText });
                    input.value = result.data.text;
                } catch (error) {
                    console.error("AI Scribe Error:", error);
                    alert("The AI Scribe couldn't respond. Please try again.");
                } finally {
                    aiBtn.disabled = false;
                    aiBtn.innerHTML = originalIcon;
                }
            });
        }
        
        function listenForMyReceipts() {
            if (unsubscribeReceipts) unsubscribeReceipts();
            const receiptsRef = collection(db, `users/${currentUser.uid}/receipts`);
            const q = query(receiptsRef, orderBy('timestamp', 'desc'));
            unsubscribeReceipts = onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('receipts-feed');
                if (!feed) return;
                feed.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = createReceiptCard(data);
                    feed.appendChild(card);
                });
            });
        }

        function createReceiptCard(data) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md border border-gray-100 receipt-card';
            const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'Just now';
            card.innerHTML = `
                <p class="text-gray-800 text-lg">${data.message}</p>
                <div class="flex items-center justify-end text-sm text-gray-400 mt-4">
                    <span>${date}</span>
                </div>
            `;
            return card;
        }

        // FRIENDS LOGIC
        function attachFriendsListeners() {
            document.getElementById('add-friend-btn').addEventListener('click', handleAddFriend);
        }
        
        function listenForFriends() {
             if (unsubscribeFriends) unsubscribeFriends();
             const profileRef = doc(db, 'profiles', currentUser.uid);
             unsubscribeFriends = onSnapshot(profileRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const userData = docSnap.data();
                     renderFriendsList(userData.friends || []);
                 }
             });
        }

        async function renderFriendsList(friendIds) {
            const listEl = document.getElementById('friends-list');
            if (!listEl) return;
            listEl.innerHTML = '<p class="text-gray-500">Loading friends...</p>';
            if (friendIds.length === 0) {
                 listEl.innerHTML = '<p class="text-gray-500">You haven\'t added any friends yet.</p>';
                 return;
            }

            const friendPromises = friendIds.map(id => getDoc(doc(db, 'profiles', id)));
            const friendDocs = await Promise.all(friendPromises);
            
            listEl.innerHTML = '';
            friendDocs.forEach(friendDoc => {
                if(friendDoc.exists()) {
                    const friendData = friendDoc.data();
                    const friendEl = document.createElement('button');
                    friendEl.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 w-full text-left transition';
                    friendEl.innerHTML = `
                        <img src="${friendData.photoURL}" alt="${friendData.name}" class="w-10 h-10 rounded-full">
                        <span class="font-semibold text-gray-700">${friendData.name}</span>
                    `;
                    friendEl.onclick = () => viewFriendStory(friendDoc.id, friendData.name);
                    listEl.appendChild(friendEl);
                }
            });
        }
        
        async function handleAddFriend() {
            const emailInput = document.getElementById('friend-email-input');
            const statusEl = document.getElementById('add-friend-status');
            const email = emailInput.value.trim().toLowerCase();
            if (!email) return;

            statusEl.textContent = 'Searching...';
            statusEl.className = 'text-blue-600 mb-2';

            const profilesRef = collection(db, 'profiles');
            const q = query(profilesRef, where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                statusEl.textContent = 'User not found.';
                statusEl.className = 'text-red-600 mb-2';
                return;
            }
            
            const friendProfile = querySnapshot.docs[0];
            const friendId = friendProfile.id;

            if (friendId === currentUser.uid) {
                statusEl.textContent = "You can't add yourself!";
                statusEl.className = 'text-yellow-600 mb-2';
                return;

            }

            const userProfileRef = doc(db, 'profiles', currentUser.uid);
            await updateDoc(userProfileRef, {
                friends: arrayUnion(friendId)
            });
            
            emailInput.value = '';
            statusEl.textContent = 'Friend added!';
            statusEl.className = 'text-green-600 mb-2';
        }
        
        let unsubscribeFriendReceipts = null;
        function viewFriendStory(friendId, friendName) {
            document.getElementById('friend-story-title').textContent = `${friendName}'s Story`;
            const feed = document.getElementById('friend-receipts-feed');
            feed.innerHTML = '<p class="text-gray-500">Loading story...</p>';

            if (unsubscribeFriendReceipts) unsubscribeFriendReceipts();
            const receiptsRef = collection(db, `users/${friendId}/receipts`);
            const q = query(receiptsRef, orderBy('timestamp', 'desc'));
            unsubscribeFriendReceipts = onSnapshot(q, (snapshot) => {
                feed.innerHTML = '';
                 if (snapshot.empty) {
                    feed.innerHTML = '<p class="text-gray-500">This story has no entries yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = createReceiptCard(data);
                    feed.appendChild(card);
                });
            });
        }

    </script>
</body>
</html>

